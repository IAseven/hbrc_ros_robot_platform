.PHONY: all clean everything


MASTER_DIRECTORY := ..
ELECTRICAL_DIRECTORY := $(MASTER_DIRECTORY)/..
HR2_DIRECTORY := $(ELECTRICAL_DIRECTORY)/..
ORDERS_DIRECTORY := $(ELECTRICAL_DIRECTORY)/orders
ORDER1_DIRECTORY := $(ORDERS_DIRECTORY)/order1
KIPARTS_DIRECTORY := $(ORDER1_DIRECTORY)/kiparts
NUCLEO_F767ZI_KIPART_CSV := $(KIPARTS_DIRECTORY)/NUCLEO_F767ZI_2xF2x35.kipart.csv
MASTER_CSV := master.csv
CUBE_DIRECTORY := hr2
CUBE_IOC = $(CUBE_DIRECTORY)/hr2.ioc

# KiCube32 stuff:
KICUBE32_DIRECTORY := $(HR2_DIRECTORY)/../kicube32
KICUBE32_PY := $(KICUBE32_DIRECTORY)/kicube32/kicube32.py
KICUBE32 := $(VIRTUAL_ENV)/bin/kicube32

all: $(NUCLEO_F767ZI_KIPART_CSV)

$(KICUBE32): $(KICUBE32_PY)
	(cd $(KICUBE32_DIRECTORY); pip install .)

# The sed in the target below is a total kludge!
$(NUCLEO_F767ZI_KIPART_CSV): $(KICUBE32) $(HR2_IOC) $(MASTER_CSV)
	$(KICUBE32) $(CUBE_IOC) $(MASTER_CSV) $(NUCLEO_F767ZI_KIPART_CSV)
	sed "s,HR2/HR2,F767ZI,g" -i $(NUCLEO_F767ZI_KIPART_CSV)

clean:
	rm -f $(NUCLEO_F767ZI_KIPART_CSV)

foo:
	@echo "VIRUTAL_ENV=$(VIRTUAL_ENV)"
	@echo "KICUBE32_DIRECTORY=$(KICUBE32_DIRECTORY)"
	@echo "KICUBE32_PY=$(KICUBE32_PY)"
	ls -l $(KICUBE32_PY)
	@echo "KICUBE32=$(KICUBE32)"
	@echo "=${KICUBE32}"
	ls -l $(KICUBE32)
